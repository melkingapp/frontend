<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª Debug Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>ØªØ³Øª Debug Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</h1>
    
    <button onclick="testExpense()">ØªØ³Øª Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
    <div id="result"></div>

    <script>
        async function testExpense() {
            try {
                // 1. Login
                console.log("ğŸ“± Ù„Ø§Ú¯ÛŒÙ†...");
                const loginResponse = await fetch('http://127.0.0.1:8000/api/v1/send-otp/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: '09123456789',
                        role: 'manager'
                    })
                });
                
                const otpData = await loginResponse.json();
                console.log('OTP Response:', otpData);
                
                if (!loginResponse.ok) {
                    throw new Error('Login failed: ' + otpData.error);
                }
                
                const otpCode = otpData.otp;
                console.log('OTP Code:', otpCode);
                
                // 2. Verify OTP
                const verifyResponse = await fetch('http://127.0.0.1:8000/api/v1/verify-otp/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: '09123456789',
                        role: 'manager',
                        otp: otpCode
                    })
                });
                
                const verifyData = await verifyResponse.json();
                console.log('Verify Response:', verifyData);
                
                if (!verifyResponse.ok) {
                    throw new Error('OTP verification failed: ' + verifyData.error);
                }
                
                const accessToken = verifyData.tokens.access;
                console.log('Access Token:', accessToken.substring(0, 50) + '...');
                
                // 3. Test expense with exact frontend data
                console.log("ğŸ’° Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡...");
                const expenseData = {
                    expense_type: "water",  // Mapped from water_bill
                    total_amount: 25000,
                    unit_selection: "all_units",
                    specific_units: [],
                    distribution_method: "equal",
                    role: "both",
                    description: "",
                    building_id: 19
                };
                
                console.log("ğŸ”¥ Sending data:", expenseData);
                
                const expenseResponse = await fetch('http://127.0.0.1:8000/api/v1/billing/register-expense/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(expenseData)
                });
                
                console.log('Response status:', expenseResponse.status);
                const responseData = await expenseResponse.json();
                console.log('Response data:', responseData);
                
                if (expenseResponse.ok) {
                    document.getElementById('result').innerHTML = 
                        `<p style="color: green;">âœ… Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!<br>
                        Ù†ÙˆØ¹: ${responseData.expense_type}<br>
                        Ù…Ø¨Ù„Øº: ${responseData.total_amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†<br>
                        ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§: ${responseData.units_count}</p>`;
                } else {
                    document.getElementById('result').innerHTML = 
                        `<p style="color: red;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡: ${responseData.error || responseData.detail}</p>`;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = 
                    `<p style="color: red;">âŒ Ø®Ø·Ø§: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
