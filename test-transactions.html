<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>ØªØ³Øª Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h1>
    
    <button onclick="testTransactions()">ØªØ³Øª Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</button>
    <div id="result"></div>

    <script>
        async function testTransactions() {
            try {
                // 1. Login
                console.log("ğŸ“± Ù„Ø§Ú¯ÛŒÙ†...");
                const loginResponse = await fetch('http://127.0.0.1:8000/api/v1/send-otp/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: '09123456789',
                        role: 'manager'
                    })
                });
                
                const otpData = await loginResponse.json();
                console.log('OTP Response:', otpData);
                
                if (!loginResponse.ok) {
                    throw new Error('Login failed: ' + otpData.error);
                }
                
                const otpCode = otpData.otp;
                console.log('OTP Code:', otpCode);
                
                // 2. Verify OTP
                const verifyResponse = await fetch('http://127.0.0.1:8000/api/v1/verify-otp/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: '09123456789',
                        role: 'manager',
                        otp: otpCode
                    })
                });
                
                const verifyData = await verifyResponse.json();
                console.log('Verify Response:', verifyData);
                
                if (!verifyResponse.ok) {
                    throw new Error('OTP verification failed: ' + verifyData.error);
                }
                
                const accessToken = verifyData.tokens.access;
                console.log('Access Token:', accessToken.substring(0, 50) + '...');
                
                // 3. Test transactions endpoint
                console.log("ğŸ’° Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§...");
                const transactionsResponse = await fetch('http://127.0.0.1:8000/api/v1/billing/transactions/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', transactionsResponse.status);
                const responseData = await transactionsResponse.json();
                console.log('Response data:', responseData);
                
                if (transactionsResponse.ok) {
                    const transactions = responseData.transactions || [];
                    document.getElementById('result').innerHTML = 
                        `<p style="color: green;">âœ… Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!<br>
                        ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§: ${transactions.length}<br>
                        Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ù„Øº: ${responseData.total_amount?.toLocaleString() || 'Ù†Ø§Ù…Ø´Ø®Øµ'} ØªÙˆÙ…Ø§Ù†</p>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
                            ${transactions.slice(0, 10).map(t => 
                                `<div style="border-bottom: 1px solid #eee; padding: 5px;">
                                    <strong>${t.title}</strong> - ${t.amount.toLocaleString()} ØªÙˆÙ…Ø§Ù† - ${t.status}
                                </div>`
                            ).join('')}
                            ${transactions.length > 10 ? `<div>... Ùˆ ${transactions.length - 10} ØªØ±Ø§Ú©Ù†Ø´ Ø¯ÛŒÚ¯Ø±</div>` : ''}
                        </div>`;
                } else {
                    document.getElementById('result').innerHTML = 
                        `<p style="color: red;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§: ${responseData.error || responseData.detail}</p>`;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = 
                    `<p style="color: red;">âŒ Ø®Ø·Ø§: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
