name: ‚öõÔ∏è Frontend CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20'
  DEPLOY_PATH: /var/www/melking/frontend-new
  NGINX_SERVICE: nginx
  FRONTEND_PORT: 8080
  BACKEND_PORT: 9000

jobs:
  build:
    name: üß™ Test & Build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Lint
        run: npm run lint
        continue-on-error: true

      - name: üèóÔ∏è Build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'https://melkingapp.ir/api/v1' }}
        run: npm run build

      - name: üì¶ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist
          if-no-files-found: error
          retention-days: 7

  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 20
    environment:
      name: production

    steps:
      - name: üì• Download artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist

      - name: üè∑Ô∏è Prepare release metadata
        id: release
        run: echo "name=release-$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üì¶ Archive build
        run: tar -czf frontend-dist.tar.gz -C dist .

      - name: üì§ Upload to server
        run: |
          scp -o StrictHostKeyChecking=no frontend-dist.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/frontend-dist.tar.gz

      - name: üìÅ Setup deployment directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << ENDSSH
            set -euo pipefail
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            
            echo "üîç Checking deployment path: \${DEPLOY_PATH}"
            
            # Check if directory exists
            if [ -d "\${DEPLOY_PATH}" ]; then
              echo "‚úÖ Directory exists: \${DEPLOY_PATH}"
              ls -la "\${DEPLOY_PATH}" || true
            else
              echo "‚ö†Ô∏è Directory does not exist, creating it..."
              sudo mkdir -p "\${DEPLOY_PATH}/releases"
              sudo mkdir -p "\${DEPLOY_PATH}/shared"
              echo "‚úÖ Directory created: \${DEPLOY_PATH}"
            fi
            
            # Ensure subdirectories exist
            sudo mkdir -p "\${DEPLOY_PATH}/releases"
            sudo mkdir -p "\${DEPLOY_PATH}/shared"
            
            # Set proper permissions
            echo "üîê Setting permissions..."
            sudo chown -R \$USER:\$USER "\${DEPLOY_PATH}" 2>/dev/null || sudo chown -R root:root "\${DEPLOY_PATH}"
            sudo chmod -R 755 "\${DEPLOY_PATH}"
            
            # Verify access
            if [ -w "\${DEPLOY_PATH}" ] || sudo test -w "\${DEPLOY_PATH}"; then
              echo "‚úÖ Directory is writable"
            else
              echo "‚ö†Ô∏è Directory may not be writable, but will use sudo for operations"
            fi
            
            echo ""
            echo "üìÇ Final directory structure:"
            ls -la "\${DEPLOY_PATH}" || true
            echo ""
            echo "‚úÖ Deployment directory setup completed"
          ENDSSH

      - name: üîç Check backend on port 9000
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << "ENDSSH"
            set -euo pipefail
            echo "Checking if backend is running on port ${{ env.BACKEND_PORT }}..."
            if netstat -tuln | grep -q ":${{ env.BACKEND_PORT }} " || ss -tuln | grep -q ":${{ env.BACKEND_PORT }} "; then
              echo "‚úÖ Backend is running on port ${{ env.BACKEND_PORT }}"
              curl -f http://localhost:${{ env.BACKEND_PORT }}/health/ || echo "‚ö†Ô∏è Backend health check failed, but port is open"
            else
              echo "‚ùå Backend is NOT running on port ${{ env.BACKEND_PORT }}"
              exit 1
            fi
          ENDSSH

      - name: ‚öôÔ∏è Setup nginx config for frontend port
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << ENDSSH
            set -euo pipefail
            NGINX_CONFIG="/etc/nginx/sites-available/frontend-new"
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            FRONTEND_PORT="${{ env.FRONTEND_PORT }}"
            BACKEND_PORT="${{ env.BACKEND_PORT }}"
            NGINX_SERVICE="${{ env.NGINX_SERVICE }}"
            
            echo "üîç Checking nginx service status..."
            if systemctl is-active --quiet "\${NGINX_SERVICE}" 2>/dev/null; then
              echo "‚úÖ Nginx service is running"
            elif systemctl is-enabled --quiet "\${NGINX_SERVICE}" 2>/dev/null; then
              echo "‚ö†Ô∏è Nginx service is enabled but not running"
            else
              echo "‚ö†Ô∏è Nginx service status unknown"
            fi
            
            echo ""
            echo "üîç Checking for port conflicts on port \${FRONTEND_PORT}..."
            if ss -tuln | grep -q ":\${FRONTEND_PORT} "; then
              echo "‚ö†Ô∏è Port \${FRONTEND_PORT} is already in use:"
              ss -tuln | grep ":\${FRONTEND_PORT} " || true
              echo "This might be nginx or another service"
            else
              echo "‚úÖ Port \${FRONTEND_PORT} is available"
            fi
            
            echo ""
            echo "üìù Creating nginx config at \${NGINX_CONFIG}..."
            TMP_CONFIG="/tmp/nginx-frontend-new.conf"
            printf '%s\n' \
              "server {" \
              "    listen 8080;" \
              "    server_name _;" \
              "    " \
              "    root /var/www/melking/frontend-new/current;" \
              "    index index.html;" \
              "    " \
              "    location / {" \
              "        try_files \\\$uri \\\$uri/ /index.html;" \
              "    }" \
              "    " \
              "    location /api/ {" \
              "        proxy_pass http://127.0.0.1:9000/api/;" \
              "        proxy_set_header Host \\\$host;" \
              "        proxy_set_header X-Real-IP \\\$remote_addr;" \
              "        proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;" \
              "        proxy_set_header X-Forwarded-Proto \\\$scheme;" \
              "        proxy_set_header Origin \\\$http_origin;" \
              "        proxy_pass_header Access-Control-Allow-Origin;" \
              "        proxy_pass_header Access-Control-Allow-Credentials;" \
              "        proxy_pass_header Access-Control-Allow-Methods;" \
              "        proxy_pass_header Access-Control-Allow-Headers;" \
              "    }" \
              "    " \
              "    location /static/ {" \
              "        proxy_pass http://127.0.0.1:9000/static/;" \
              "    }" \
              "    " \
              "    location /media/ {" \
              "        proxy_pass http://127.0.0.1:9000/media/;" \
              "    }" \
              "}" > "\${TMP_CONFIG}"
            sudo cp "\${TMP_CONFIG}" "\${NGINX_CONFIG}"
            rm -f "\${TMP_CONFIG}"
            echo "‚úÖ Config file created"
            echo ""
            echo "üìÑ Config file content:"
            cat "\${NGINX_CONFIG}"
            echo ""
            
            echo "üîó Creating symlink..."
            sudo ln -sf "\${NGINX_CONFIG}" /etc/nginx/sites-enabled/frontend-new
            if [ -L /etc/nginx/sites-enabled/frontend-new ]; then
              echo "‚úÖ Symlink created successfully"
            else
              echo "‚ùå Failed to create symlink"
              exit 1
            fi
            echo ""
            
            echo "üîç Verifying nginx config syntax..."
            if sudo nginx -t 2>&1; then
              echo "‚úÖ Nginx config is valid"
            else
              echo "‚ùå Nginx config test failed!"
              echo ""
              echo "Checking nginx error log..."
              sudo tail -50 /var/log/nginx/error.log 2>/dev/null || echo "Could not read error log"
              echo ""
              echo "Checking systemd journal..."
              sudo journalctl -u "\${NGINX_SERVICE}" -n 30 --no-pager || true
              echo ""
              echo "Config file content:"
              cat "\${NGINX_CONFIG}"
              exit 1
            fi
            echo ""
            
            echo "üîÑ Reloading nginx service..."
            if sudo systemctl reload "\${NGINX_SERVICE}" 2>&1; then
              echo "‚úÖ Nginx reloaded successfully"
              sleep 2
            else
              echo "‚ö†Ô∏è Reload failed, checking status..."
              sudo systemctl status "\${NGINX_SERVICE}" --no-pager -l || true
              echo ""
              echo "Checking journal logs..."
              sudo journalctl -u "\${NGINX_SERVICE}" -n 30 --no-pager || true
              echo ""
              echo "Checking error log..."
              sudo tail -50 /var/log/nginx/error.log 2>/dev/null || true
              echo ""
              echo "Attempting restart..."
              if sudo systemctl restart "\${NGINX_SERVICE}" 2>&1; then
                echo "‚úÖ Nginx restarted successfully"
                sleep 3
              else
                echo "‚ùå Nginx restart failed!"
                echo ""
                echo "Full systemd status:"
                sudo systemctl status "\${NGINX_SERVICE}" --no-pager -l || true
                echo ""
                echo "Recent journal entries:"
                sudo journalctl -u "\${NGINX_SERVICE}" -n 50 --no-pager || true
                echo ""
                echo "Error log:"
                sudo tail -100 /var/log/nginx/error.log 2>/dev/null || true
                echo ""
                echo "Testing nginx config again:"
                sudo nginx -t 2>&1 || true
                exit 1
              fi
            fi
            
            echo ""
            echo "üîç Verifying nginx is running..."
            if systemctl is-active --quiet "\${NGINX_SERVICE}"; then
              echo "‚úÖ Nginx service is active"
            else
              echo "‚ùå Nginx service is not active!"
              sudo systemctl status "\${NGINX_SERVICE}" --no-pager || true
              exit 1
            fi
            
            echo ""
            echo "üîç Checking if nginx is listening on port \${FRONTEND_PORT}..."
            sleep 2
            if ss -tuln | grep -q ":\${FRONTEND_PORT} "; then
              echo "‚úÖ Nginx is listening on port \${FRONTEND_PORT}"
              ss -tuln | grep ":\${FRONTEND_PORT} " || true
            else
              echo "‚ö†Ô∏è Nginx is not listening on port \${FRONTEND_PORT}"
              echo ""
              echo "Checking nginx status..."
              sudo systemctl status "\${NGINX_SERVICE}" --no-pager || true
              echo ""
              echo "Checking nginx error log..."
              sudo tail -50 /var/log/nginx/error.log 2>/dev/null || true
              echo ""
              echo "Listing enabled sites..."
              ls -la /etc/nginx/sites-enabled/ || true
              echo ""
              echo "Testing nginx full config..."
              sudo nginx -T 2>&1 | grep -A 15 "frontend-new" || echo "Config not found in nginx test"
              echo ""
              echo "Attempting one more restart..."
              sudo systemctl restart "\${NGINX_SERVICE}"
              sleep 5
              if ss -tuln | grep -q ":\${FRONTEND_PORT} "; then
                echo "‚úÖ Nginx is now listening on port \${FRONTEND_PORT}"
              else
                echo "‚ùå Nginx failed to listen on port \${FRONTEND_PORT} after restart"
                exit 1
              fi
            fi
            echo ""
            echo "‚úÖ Nginx setup completed successfully"
          ENDSSH

      - name: ‚ôªÔ∏è Deploy release
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << ENDSSH
            set -euo pipefail
            RELEASE_NAME="${{ steps.release.outputs.name }}"
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            FRONTEND_PORT="${{ env.FRONTEND_PORT }}"
            
            echo "üì¶ Deploying release: \${RELEASE_NAME}"
            echo "üìÇ Deployment path: \${DEPLOY_PATH}"
            
            # Ensure directories exist with sudo
            sudo mkdir -p "\${DEPLOY_PATH}/releases"
            sudo mkdir -p "\${DEPLOY_PATH}/shared"
            
            RELEASE_DIR="\${DEPLOY_PATH}/releases/\${RELEASE_NAME}"
            echo "üìÅ Release directory: \${RELEASE_DIR}"
            
            # Remove old release if exists and create new one
            sudo rm -rf "\${RELEASE_DIR}"
            sudo mkdir -p "\${RELEASE_DIR}"
            
            # Extract files
            echo "üì§ Extracting files..."
            sudo tar -xzf /tmp/frontend-dist.tar.gz -C "\${RELEASE_DIR}"
            sudo rm -f /tmp/frontend-dist.tar.gz
            
            # Create symlink
            echo "üîó Creating symlink..."
            sudo ln -sfn "\${RELEASE_DIR}" "\${DEPLOY_PATH}/current"
            
            # Verify symlink
            if [ -L "\${DEPLOY_PATH}/current" ]; then
              echo "‚úÖ Symlink created: \${DEPLOY_PATH}/current -> \$(readlink -f \${DEPLOY_PATH}/current)"
            else
              echo "‚ùå Failed to create symlink"
              exit 1
            fi
            if command -v chown >/dev/null 2>&1; then
              sudo chown -R www-data:www-data "\${DEPLOY_PATH}" || true
            fi
            echo ""
            echo "üîÑ Reloading nginx after deployment..."
            if sudo systemctl reload "${{ env.NGINX_SERVICE }}" 2>&1; then
              echo "‚úÖ Nginx reloaded successfully"
            else
              echo "‚ö†Ô∏è Nginx reload failed, trying restart..."
              if sudo systemctl restart "${{ env.NGINX_SERVICE }}" 2>&1; then
                echo "‚úÖ Nginx restarted successfully"
              else
                echo "‚ùå Nginx restart failed!"
                sudo systemctl status "${{ env.NGINX_SERVICE }}" --no-pager || true
                sudo journalctl -u "${{ env.NGINX_SERVICE }}" -n 20 --no-pager || true
              fi
            fi
            sleep 2
            echo "‚úÖ Release deployed to \${RELEASE_DIR}"
            echo "üåê Frontend available at: http://${{ secrets.SSH_HOST }}:\${FRONTEND_PORT}"
            echo ""
            echo "üîç Verifying nginx configuration..."
            if netstat -tuln | grep -q ":\${FRONTEND_PORT} " || ss -tuln | grep -q ":\${FRONTEND_PORT} "; then
              echo "‚úÖ Nginx is listening on port \${FRONTEND_PORT}"
            else
              echo "‚ö†Ô∏è Nginx is not listening on port \${FRONTEND_PORT}"
              echo "Checking nginx status..."
              sudo systemctl status "${{ env.NGINX_SERVICE }}" --no-pager || true
            fi
            echo ""
            echo "üè• Testing frontend locally..."
            if curl -f -s http://localhost:\${FRONTEND_PORT} > /dev/null 2>&1; then
              echo "‚úÖ Frontend is responding on localhost:\${FRONTEND_PORT}"
            else
              echo "‚ö†Ô∏è Frontend health check failed (may need firewall rules)"
            fi
          ENDSSH

      - name: üè• External health check
        continue-on-error: true
        run: |
          FRONTEND_URL="http://${{ secrets.SSH_HOST }}:${{ env.FRONTEND_PORT }}"
          echo "Checking frontend externally at ${FRONTEND_URL}..."
          if curl -fsSL --max-time 5 -o /dev/null "${FRONTEND_URL}"; then
            echo "‚úÖ Frontend is accessible externally on port ${{ env.FRONTEND_PORT }}"
          else
            echo "‚ö†Ô∏è Frontend is not accessible externally (may need firewall rules)"
            echo "To open port ${{ env.FRONTEND_PORT }}, run on server:"
            echo "  sudo ufw allow ${{ env.FRONTEND_PORT }}/tcp"
          fi

  notify:
    name: üîî Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: ‚úÖ Success
        if: needs.deploy.result == 'success'
        run: |
          echo "‚úÖ Frontend deployed successfully to ${{ secrets.DEPLOYMENT_URL }}"

      - name: ‚ùå Failure
        if: needs.deploy.result != 'success'
        run: |
          echo "‚ùå Frontend deployment failed. Please review the logs."

